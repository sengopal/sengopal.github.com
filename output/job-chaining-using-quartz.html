<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">
<head>
    <title>Job chaining using Quartz</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Open Graph tags -->

            <meta property="og:type" content="article"/>
            <meta property="og:title" content="Job chaining using Quartz"/>
            <meta property="og:url" content="/job-chaining-using-quartz.html"/>
            <meta property="og:description" content="Using Quartz to chain jobs rather than scheduling for indeterminate running time"/>

    <!-- Bootstrap -->
        <link rel="stylesheet" href="/theme/css/bootstrap.flatly.min.css" type="text/css"/>
    <link href="/theme/css/font-awesome.min.css" rel="stylesheet">
    <link href="/theme/css/pygments.css" rel="stylesheet">
    <link rel="stylesheet" href="/theme/css/style.css" type="text/css"/>
    <!-- JavaScript plugins (requires jQuery) -->
    <script src="http://code.jquery.com/jquery.js"></script>


</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="" class="navbar-brand">Senthil Gopal</a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li >
                            <a href="/category/android.html">Android</a>
                        </li>
                        <li >
                            <a href="/category/design.html">Design</a>
                        </li>
                        <li >
                            <a href="/category/java.html">Java</a>
                        </li>
                        <li >
                            <a href="/category/lists.html">Lists</a>
                        </li>
                        <li class="active">
                            <a href="/category/papers.html">Papers</a>
                        </li>
                        <li >
                            <a href="/category/projects.html">Projects</a>
                        </li>
                        <li >
                            <a href="/category/ramblings.html">Ramblings</a>
                        </li>
                        <li >
                            <a href="/category/utilities.html">Utilities</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="/archives.html"><i class="icon-th-list"></i>Archives</a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</nav>
<!-- /.navbar -->
<div class="container">
    <div class="row">
        <div class="col-lg-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="/job-chaining-using-quartz.html"
                       rel="bookmark"
                       title="Permalink to Job chaining using Quartz">
                        Job chaining using Quartz
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="icon-calendar"></i>31 Mar 2009
    </span>



<span class="label label-default">Tags</span>
	<a href="/tag/quartz.html">quartz</a>
        /
	<a href="/tag/java.html">java</a>
</footer><!-- /.post-info -->                    </div>
                </div>
                <h3>Project Usage</h3>
<p>Our Project had the requirement of reading a set of records from a table which acts as a queue and sends the pending mails. This reading /sending of mails has to happen every five minutes. However, since the SMTP server needs to address online mailing at times, this job may run more than the given five minutes. Also, if the number of records in the table is high, the Job exceeds the expected time of completion of five minutes. Hence it was decided to “chain” the jobs with a five minute delay.</p>
<h3>Introduction to Quartz</h3>
<p>Quartz is an open source job scheduling framework that provides simple but powerful mechanisms for job scheduling in Java applications. Quartz allows developers to schedule jobs by time interval or by time of day. It implements many-to-many relationships for jobs and triggers and can associate multiple jobs with different triggers.
Applications that incorporate Quartz can reuse jobs from different events and also group multiple jobs for a single event. While you can configure Quartz through a property file (in which you can specify a data source for JDBC transactions, global job and/or trigger listeners, plug-ins, thread pools, and more) it is not at all integrated with the application server's context or references.</p>
<h3>Jobs and triggers</h3>
<p>The two fundamental units of Quartz's scheduling package are jobs and triggers. A job is an executable task that can be scheduled, while a trigger provides a schedule for a job. While these two entities could easily have been combined, their separation in Quartz is both intentional and beneficial. By keeping the work to be performed separate from its scheduling, Quartz allows you to change the scheduled trigger for a job without losing the job itself, or the context around it. Also, any singular job can have many triggers associated with it.</p>
<h3>Simple Job Example</h3>
<p>An example of a Quartz job is given below. This class overrides the execute () (JobExecutionContext context) method with a very simple output statement. This method can contain any code that constitutes the job to be executed</p>
<h4>SimpleQuartzJob.java</h4>
<div class="highlight"><pre><span class="n">import</span> <span class="n">java</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">Date</span><span class="p">;</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">quartz</span><span class="p">.</span><span class="n">Job</span><span class="p">;</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">quartz</span><span class="p">.</span><span class="n">JobExecutionContext</span><span class="p">;</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">quartz</span><span class="p">.</span><span class="n">JobExecutionException</span><span class="p">;</span>

<span class="n">public</span> <span class="n">class</span> <span class="n">SimpleQuartzJob</span> <span class="n">implements</span> <span class="n">Job</span> <span class="p">{</span>

    <span class="n">public</span> <span class="n">SimpleQuartzJob</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="kt">void</span> <span class="n">execute</span><span class="p">(</span><span class="n">JobExecutionContext</span> <span class="n">context</span><span class="p">)</span> <span class="n">throws</span> <span class="n">JobExecutionException</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;In SimpleQuartzJob - executing its JOB at &quot;</span>
                <span class="o">+</span> <span class="n">new</span> <span class="n">Date</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot; by &quot;</span> <span class="o">+</span> <span class="n">context</span><span class="p">.</span><span class="n">getTrigger</span><span class="p">().</span><span class="n">getName</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p><em>Notice that the execute method takes a JobExecutionContext object as an argument. This object provides the runtime context around the job instance. Specifically, it gives access to the scheduler and trigger, which collaborated to initiate execution of the job as well as the job's JobDetail object. Quartz separates the execution and the surrounding state of a job by placing the state in a JobDetail object and having the JobDetail constructor initiate an instance of a job. The JobDetail object stores the job's listeners, group, data map, description, and other properties of the job.</em></p>
<h4>Simple Trigger Example</h4>
<p>A trigger develops a schedule for job execution. Quartz offers a few different trigger options of varying complexity. The SimpleTrigger given below shows the fundamentals of triggers.</p>
<h4>SimpleTriggerRunner.java</h4>
<div class="highlight"><pre><span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">quartz</span><span class="p">.</span><span class="n">JobDetail</span><span class="p">;</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">quartz</span><span class="p">.</span><span class="n">Scheduler</span><span class="p">;</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">quartz</span><span class="p">.</span><span class="n">SchedulerException</span><span class="p">;</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">quartz</span><span class="p">.</span><span class="n">Trigger</span><span class="p">;</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">quartz</span><span class="p">.</span><span class="n">TriggerUtils</span><span class="p">;</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">quartz</span><span class="p">.</span><span class="n">impl</span><span class="p">.</span><span class="n">StdSchedulerFactory</span><span class="p">;</span>

<span class="n">public</span> <span class="n">class</span> <span class="n">Test</span><span class="p">{</span>
    <span class="n">public</span> <span class="kt">void</span> <span class="n">scheduleTask</span><span class="p">()</span> <span class="n">throws</span> <span class="n">SchedulerException</span> <span class="p">{</span>
        <span class="n">try</span><span class="p">{</span>
            <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Starting the scheduler in Quartz&quot;</span><span class="p">);</span>
            <span class="n">StdSchedulerFactory</span> <span class="n">schedFact</span> <span class="o">=</span> <span class="n">new</span> <span class="n">StdSchedulerFactory</span><span class="p">();</span>
            <span class="n">Scheduler</span> <span class="n">sched</span> <span class="o">=</span> <span class="n">schedFact</span><span class="p">.</span><span class="n">getScheduler</span><span class="p">();</span>
            <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Scheduling a Tickler job in Quartz&quot;</span><span class="p">);</span>

                <span class="c1">//Making a daily Trigger for the Job</span>
            <span class="n">Trigger</span> <span class="n">simpleTrigger</span> <span class="o">=</span> <span class="n">TriggerUtils</span><span class="p">.</span><span class="n">makeDailyTrigger</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mo">00</span><span class="p">);</span>
            <span class="n">simpleTrigger</span><span class="p">.</span><span class="n">setName</span><span class="p">(</span><span class="s">&quot;SimpleQuartzTrigger&quot;</span><span class="p">);</span>
            <span class="n">simpleTrigger</span><span class="p">.</span><span class="n">setGroup</span><span class="p">(</span><span class="n">Scheduler</span><span class="p">.</span><span class="n">DEFAULT_GROUP</span><span class="p">);</span>
            <span class="n">JobDetail</span> <span class="n">simpleJob</span> <span class="o">=</span> <span class="n">new</span> <span class="n">JobDetail</span><span class="p">(</span><span class="s">&quot;SimpleQuartzJob&quot;</span><span class="p">,</span> <span class="n">Scheduler</span><span class="p">.</span><span class="n">DEFAULT_GROUP</span><span class="p">,</span> <span class="n">SimpleQuartzJob</span><span class="p">.</span><span class="n">class</span><span class="p">);</span>
            <span class="n">sched</span><span class="p">.</span><span class="n">scheduleJob</span><span class="p">(</span><span class="n">simpleJob</span><span class="p">,</span><span class="n">simpleTrigger</span><span class="p">);</span>
            <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Tickler Mail Job Scheduled&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">catch</span><span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">){</span>
            <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Error while scheduling the jobs.&quot;</span><span class="p">);</span>
            <span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>The scheduling method starts by instantiating a SchedulerFactory and getting the scheduler. As discussed earlier, the JobDetail object is created by taking the Job (SimpleQuartzJob) as an argument to its constructor. The TriggerUtils.makeDailyTrigger creates a simple trigger which executes the associated job(s) at 2:00 am everyday
There are a number of other ways to manipulate a SimpleTrigger. In addition to a specified number of repeats and a specified repeat interval, jobs may be schedules to execute at a specific calendar time, given a maximum time of execution, or given a priority. Some of the advanced concepts include CronTriggers, Job Stores, and JobMap etc.,</p>
<h3>Need for Job Chaining</h3>
<p>The job known as “MailProcessor” needs to be scheduled every 5 minutes i.e., this job has to execute every five minutes. The code which was used for scheduling the job is given below:</p>
<div class="highlight"><pre><span class="n">Trigger</span> <span class="n">mailProcTrigger</span> <span class="o">=</span> <span class="n">TriggerUtils</span><span class="p">.</span><span class="n">makeMinutelyTrigger</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="n">mailProcTrigger</span><span class="p">.</span><span class="n">setName</span><span class="p">(</span><span class="n">SchedulingConstants</span><span class="p">.</span><span class="n">MAILPROCESSOR_TRIGGER_NAME</span><span class="p">);</span>
<span class="n">mailProcTrigger</span><span class="p">.</span><span class="n">setGroup</span><span class="p">(</span><span class="n">Scheduler</span><span class="p">.</span><span class="n">DEFAULT_GROUP</span><span class="p">);</span>
<span class="n">JobDetail</span> <span class="n">mailProc</span> <span class="o">=</span> <span class="n">new</span> <span class="n">JobDetail</span><span class="p">(</span><span class="n">SchedulingConstants</span><span class="p">.</span><span class="n">MAILPROCESSOR_JOB_NAME</span><span class="p">,</span> <span class="n">Scheduler</span><span class="p">.</span><span class="n">DEFAULT_GROUP</span><span class="p">,</span> <span class="n">MailProcessor</span><span class="p">.</span><span class="n">class</span><span class="p">);</span>
<span class="n">sched</span><span class="p">.</span><span class="n">scheduleJob</span><span class="p">(</span><span class="n">mailProc</span><span class="p">,</span><span class="n">mailProcTrigger</span><span class="p">);</span>
<span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Mail Processor Scheduled&quot;</span><span class="p">);</span>
</pre></div>


<p>Following are the issues faced with this kind of scheduling</p>
<ol>
<li>The SMTP Server needs to address online mailing at times.</li>
<li>The number of records in the table is high and hence the number of mails to be sent are higher in number</li>
<li>Due to the above reasons, this job may have a completion of time of more than five minutes, which means that the next schedule of the same will get triggered even before the first one completes.</li>
</ol>
<p><strong>Solution</strong></p>
<p>Hence to resolve this, we need to chain the jobs such that the job gets “re-scheduled” only after the first job is completed. This is known as “Job-Chaining”</p>
<h3>Job Chaining – How it was implemented</h3>
<ol>
<li>A Utility Method for returning the time 5 minutes from now and another Utility method for returning a SimpleTrigger using the NextScheduledTime are created.</li>
<li>The first time scheduling of the Job is done with a SimpleTrigger (Utility method) which starts the first job 5 minutes from the starting instance</li>
</ol>
<p>{% highlight java %}
//The Utility method to return the Next Scheduling time 5 minutes from now
public static Date getNextMailScheduledTime() {
    Calendar cal = Calendar.getInstance();
    System.out.println("Date Current: "+cal.getTimeInMillis());
    cal.add(Calendar.MINUTE,1);
    System.out.println("Date after addition: "+cal.getTimeInMillis());
    return cal.getTime();
}</p>
<p _="%" endhighlight="endhighlight">//The Utility Method to return a SimpleTrigger which used the NextScheduledTime Utility Method for the Triggering time
public static Trigger getMailProcessorTrigger() {
    Date newDate = VsimsUtil.getNextMailScheduledTime();
    Trigger mailTrigger = new SimpleTrigger(SchedulingConstants.MAILPROCESSOR_TRIGGER_NAME, Scheduler.DEFAULT_GROUP,newDate);
    mailTrigger.setJobName(SchedulingConstants.MAILPROCESSOR_JOB_NAME);
    mailTrigger.setJobGroup(Scheduler.DEFAULT_GROUP);
    return mailTrigger;
}</p>
<h3>Scheduling the Job for the First Run</h3>
<ol>
<li>Using the Utility methods the “MailProcessor” Job is scheduled to run after Five minutes from the current Instance</li>
<li>Since a specific time instance is given for the Trigger, this Job will get Triggered only once</li>
</ol>
<p _="%" endhighlight="endhighlight">{% highlight java %}
JobDetail mailJobDetail = new JobDetail("MailProcessorJob",Scheduler.DEFAULT_GROUP, MailProcessor.class);
sched.scheduleJob(mailJobDetail,VsimsUtil Util.getMailProcessorTrigger());
logger.info("Mail Processor Scheduled");</p>
<p>Note: <em>Since the Job is being scheduled for the first time we have to use sched.scheduleJob() for scheduling the job</em></p>
<p>In the Execute method of the Job, once the Job gets fired for the first time by the Trigger created, the Job Execution steps are completed and then the job gets “re-scheduled’ after five minutes using the same Utility method</p>
<div class="highlight"><pre><span class="n">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="p">(</span><span class="n">JobExecutionContext</span> <span class="n">jobContext</span><span class="p">)</span> <span class="n">throws</span> <span class="n">JobExecutionException</span> <span class="p">{</span>
        <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;MailProcessor execute - start&quot;</span><span class="p">);</span>

        <span class="c1">//PERFORM THE JOB EXECUTION STEPS HERE</span>
        <span class="c1">//Chaining of the Job by re-scheduling</span>
        <span class="n">try</span> <span class="p">{</span>
            <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Scheduler Instance Id in Mail Processor: &quot;</span><span class="o">+</span>
                <span class="o">+</span> <span class="n">jobContext</span><span class="p">.</span><span class="n">getScheduler</span><span class="p">().</span><span class="n">getSchedulerInstanceId</span><span class="p">());</span>

            <span class="c1">//If Rescheduled Correctly, the Scheduler returns the next Scheduled Time of the JOB</span>
            <span class="n">Date</span> <span class="n">nextScheduledTime</span> <span class="o">=</span> <span class="n">jobContext</span><span class="p">.</span><span class="n">getScheduler</span><span class="p">().</span><span class="n">rescheduleJob</span>
                <span class="p">(</span><span class="s">&quot;MailProcessorJob&quot;</span><span class="p">,</span> <span class="n">Scheduler</span><span class="p">.</span><span class="n">DEFAULT_GROUP</span><span class="p">,</span> <span class="n">Util</span><span class="p">.</span><span class="n">getMailProcessorTrigger</span><span class="p">());</span>
            <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Rescheduled at : &quot;</span><span class="o">+</span><span class="n">nextScheduledTime</span><span class="p">);</span>
        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">SchedulerException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Error in Scheduling the Job for the Next Iteration&quot;</span><span class="p">);</span>
            <span class="n">e</span><span class="p">.</span><span class="n">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span>

<span class="p">}</span>
</pre></div>


<p>Note: <em>Since the same job is being chained, we have to use rescheduleJob().</em></p>
<p>The re-scheduling also happens using the Trigger returned by the Utility Method. Hence the job gets rescheduled only once. Hence the subsequent run of the job will reschedule the job again for its next run. Thus we achieve chaining of the job runs</p>
<p>References
<em> <a href="http://quartz.sourceforge.net/firstTutorial.html">http://quartz.sourceforge.net/firstTutorial.html</a>
</em> <a href="http://www-128.ibm.com/developerworks/java/library/j-quartz/">http://www-128.ibm.com/developerworks/java/library/j-quartz/</a></p>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-lg-3 well well-sm" id="sidebar">
<aside>
    <section>
        <ul class="list-group list-group-flush">
                <li class="list-group-item"><h4><i class="icon-home icon-large"></i>Social</h4></li>
                    <li class="list-group-item"><a href="https://twitter.com/sengopal"><i
                            class="icon-twitter-sign icon-large"></i>twitter
                    </a></li>
                    <li class="list-group-item"><a href="http://github.com/sengopal/"><i
                            class="icon-github-sign icon-large"></i>github
                    </a></li>



        </ul>
    </section>


    <section>
    <ul class="list-group list-group-flush">
    <li class="list-group-item"><h4><i class="icon-github icon-large"></i>GitHub Repos</h4></li>
        <div id="gh_repos">
            <p class="list-group-item">Status updating...</p>
        </div>
    </ul>
        <script type="text/javascript">
            $(document).ready(function () {
                if (!window.jXHR) {
                    var jxhr = document.createElement('script');
                    jxhr.type = 'text/javascript';
                    jxhr.src = '/theme/js/jXHR.js';
                    var s = document.getElementsByTagName('script')[0];
                    s.parentNode.insertBefore(jxhr, s);
                }

                github.showRepos({
                    user: 'sengopal',
                    count: 5,
                    skip_forks: true,
                    target: '#gh_repos'
                });
            });
        </script>
        <script src="/theme/js/github.js" type="text/javascript"></script>
    </section>
</aside>        </div>
    </div>
</div>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="/theme/js/respond.min.js"></script>
</body>
</html>